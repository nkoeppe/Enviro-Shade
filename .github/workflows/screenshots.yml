name: Update Screenshots

on:
  push:
    paths:
      - 'src/**'
      - 'scripts/demo/**'
      - 'scripts/screenshots-chrome.js'
  workflow_dispatch:
  schedule:
    # Run weekly to ensure screenshots stay fresh
    - cron: '0 6 * * 1'

permissions:
  contents: write

jobs:
  generate-screenshots:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Install Playwright browsers
      run: npx playwright install chromium
      
    - name: Start demo applications
      run: |
        cd scripts/demo
        node start-node.js &
        DEMO_PID=$!
        echo "Demo server started with PID: $DEMO_PID"
        echo "DEMO_PID=$DEMO_PID" >> $GITHUB_ENV
        sleep 10
        
        # Verify apps are responding
        if ! curl -f http://localhost:3000 > /dev/null 2>&1; then
          echo "❌ Demo app 1 not responding"
          exit 1
        fi
        if ! curl -f http://localhost:3001 > /dev/null 2>&1; then
          echo "❌ Demo app 2 not responding"
          exit 1
        fi
        echo "✅ Both demo apps are responding"
        
    - name: Generate Chrome screenshots
      run: |
        set -e  # Exit on any error
        npm run screenshots:chrome
        
    - name: Stop demo applications
      if: always()
      run: |
        if [ -n "$DEMO_PID" ]; then
          kill $DEMO_PID 2>/dev/null || true
        fi
        pkill -f "node start-node.js" 2>/dev/null || true
      
        
    - name: Check if screenshots changed
      id: changes
      run: |
        if git diff --quiet docs/assets/screenshots/; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No screenshot changes detected"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Screenshots have been updated"
        fi
        
    - name: Commit updated screenshots
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add docs/assets/screenshots/
        git commit -m "docs: update automated screenshots"
        git push
        
    - name: Summary
      run: |
        echo "## Screenshot Update Summary" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ steps.changes.outputs.changed }}" == "true" ]]; then
          echo "✅ Screenshots were updated and committed" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ No changes detected in screenshots" >> $GITHUB_STEP_SUMMARY
        fi
