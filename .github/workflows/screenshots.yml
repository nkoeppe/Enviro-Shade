name: Update Screenshots

on:
  push:
    paths:
      - 'src/**'
      - 'scripts/demo/**'
      - 'scripts/screenshots-chrome.js'
  workflow_dispatch:
  schedule:
    # Run weekly to ensure screenshots stay fresh
    - cron: '0 6 * * 1'

jobs:
  build-images:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build demo app images
      run: |
        cd scripts/demo
        docker build -t demo-app1:latest ./site1
        docker build -t demo-app2:latest ./site2
        
    - name: Save images
      run: |
        docker save demo-app1:latest > /tmp/demo-app1.tar
        docker save demo-app2:latest > /tmp/demo-app2.tar
        
    - name: Upload images
      uses: actions/upload-artifact@v4
      with:
        name: demo-images
        path: /tmp/demo-app*.tar

  generate-screenshots:
    runs-on: ubuntu-latest
    needs: build-images
    
    services:
      demo-app1:
        image: demo-app1:latest
        ports:
          - 3000:80
          
      demo-app2:
        image: demo-app2:latest
        ports:
          - 3001:80
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download images
      uses: actions/download-artifact@v4
      with:
        name: demo-images
        path: /tmp/
        
    - name: Load images
      run: |
        docker load < /tmp/demo-app1.tar
        docker load < /tmp/demo-app2.tar
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Install Playwright browsers
      run: npx playwright install chromium
      
    - name: Wait for services
      run: |
        echo "Waiting for demo applications..."
        sleep 15
        
    - name: Generate Chrome screenshots
      run: npm run screenshots:chrome
      
        
    - name: Check if screenshots changed
      id: changes
      run: |
        if git diff --quiet docs/assets/screenshots/; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No screenshot changes detected"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Screenshots have been updated"
        fi
        
    - name: Commit updated screenshots
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add docs/assets/screenshots/
        git commit -m "docs: update automated screenshots

        🤖 Generated with [Claude Code](https://claude.ai/code)

        Co-Authored-By: Claude <noreply@anthropic.com>"
        git push
        
    - name: Summary
      run: |
        echo "## Screenshot Update Summary" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ steps.changes.outputs.changed }}" == "true" ]]; then
          echo "✅ Screenshots were updated and committed" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ No changes detected in screenshots" >> $GITHUB_STEP_SUMMARY
        fi